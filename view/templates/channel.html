<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="stylesheet" href="/static/css/index.css"/>
    <link rel="stylesheet" href="/static/css/global.css">
    <script src="/static/js/vue.js"></script>
    <script src="/static/js/layui-vue.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <script src="/static/js/config.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">


</head>
<body>
<div id="app" style="padding: 10px 10px 10px 10px">
    <lay-field title="通道管理"></lay-field>

    <lay-space direction="vertical">
        <lay-space>
            <lay-button type="primary" @click="this.action.openInfoCreate=true">添加通道</lay-button>

        </lay-space>
        <lay-table :columns="infoTableOption.columns" :page="infoTableOption.page" :data-source="infoTableOption.data"
                   :loading="infoTableOption.loading" @change="changeInfoTable" id="id">

            <template v-slot:status="{ data }">
                <lay-switch v-model="data.status" onswitch-text="启用" :onswitch-value="10" unswitch-text="禁用" :unswitch-value="0" @click="changeInfoStatus(data)"></lay-switch>
            </template>

        </lay-table>
    </lay-space>


    <!--    弹出层统一放置-->
    <div>
        <lay-layer title="新建通道" maxmin :shade="true" :shade-close="false" style="text-align: center;" area="60%"
                   resize move v-model="action.openInfoCreate">

            <lay-form :model="infoCreateForm" ref="icf" required initValidate style="margin: 15px 15px 15px 15px">
                <lay-form-item label="通道名称" prop="name" :rules="{min:2,max:20,message:'通道名称为5至20字'}">
                    <lay-input v-model="infoCreateForm.name" prefix-icon="layui-icon-person" size="lg"></lay-input>
                </lay-form-item>

                <lay-ripple>
                    <lay-button type="warm" @click="submitInfoCreate">创建</lay-button>


                </lay-ripple>
            </lay-form>

        </lay-layer>

    </div>
</div>
<script>
    const App = {

        data() {
            return {
                infoCreateForm: {
                    name: "",

                },
                action: {
                    openInfoCreate: false,
                },
                ds: [],
                infoTableOption: {
                    columns: [
                        {
                            title: "id",
                            width: "200px",
                            key: "id",
                            align: "center"
                        },
                        {
                            title: "通道名",
                            width: "200px",
                            key: "name",
                            align: "center"
                        },
                        {
                            title: "状态",
                            width: "200px",
                            customSlot:'status',
                            key: "status",
                            align: "center"
                        },
                        {
                            title: "创建时间",
                            customSlot:'createTime',
                            width: "200px",
                            key: "createTime",
                            align: "center"
                        }
                    ],
                    page: {
                        total: 0,
                        limit: 10,
                        current: 1,
                        showRefresh: true,
                    },
                    data: [],
                    searchValue: {},
                    loading: false
                }

            };
        },
        created() {
            this.loadInfoPage()
        },
        watch: {

            action: {
                handler(next, _) {
                    if (!next.openInfoCreate) {
                        this.$refs.icf.reset()

                    }

                },
                deep: true
            }

        },
        methods: {
            changeInfoStatus(data){
                let index = this.$util.getArrayItemIndex(this.infoTableOption.data,data,"id")
                console.log(index)
            },
            changeInfoTable(data) {
                this.infoTableOption.page.current = data.current
                this.infoTableOption.page.limit = data.limit

                this.loadInfoPage()
            },
            loadInfoPage() {


                let param = {
                    page: this.infoTableOption.page.current,
                    limit: this.infoTableOption.page.limit,
                    params: {
                        ...this.infoTableOption.searchValue
                    }
                }
                this.infoTableOption.loading = true
                this.$request.post("/admin/channel/channel_info/load", param).then(res => {
                    if (res.code == 1) {

                        this.infoTableOption.data = res.data
                        this.infoTableOption.page.total = res.count

                    } else {
                        LayuiVue.layer.msg(`${res.msg},加载通道信息失败`, {icon: 2, time: 1000})

                    }
                }).catch((res) => {
                    LayuiVue.layer.msg("网络错误，请稍后再试", {icon: 2, time: 1000})
                }).finally(() => {
                    this.infoTableOption.loading = false

                })

            },
            submitInfoCreate() {

                this.$refs.icf.validate((isValidate, model, errors) => {
                    if (!isValidate) {
                        return false
                    } else {
                        this.$request.post("/admin/channel/channel_info/create", {...this.infoCreateForm}).then(res => {
                            if (res.code === 1) {

                                LayuiVue.layer.msg("创建推送通道成功", {icon: 1, time: 1000,})

                            } else {
                                LayuiVue.layer.msg(`${res.msg},创建推送通道失败`, {icon: 2, time: 1000})

                            }
                        }).catch((res) => {
                            LayuiVue.layer.msg("网络错误，请稍后再试", {icon: 2, time: 1000})
                        })

                    }


                })


            },
        }
    };
    const app = Vue.createApp(App);
    app.use(LayuiVue);
    app.use(http)
    app.use(util)

    app.mount("#app");
</script>

<style>


</style>
</body>
</html>